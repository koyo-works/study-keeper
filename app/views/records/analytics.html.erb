<div style="text-align: center; margin-bottom: 2rem;">
  <h1 style="font-size: 36px; font-weight: 700; color: #667eea; margin-bottom: 8px;">
    ğŸ“Š è¨˜éŒ²ã‚µãƒãƒªãƒ¼
  </h1>
  <p style="color: #6B7280; font-size: 16px;">
    ä»Šå–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã“ã¨ã‚’é¸æŠã—ã¦ãã ã•ã„
  </p>
</div>

<div class="analytics-wrapper">
  <!-- ä»Šé€±ã®å‰²åˆ -->
  <div class="analytics-container p-6">
    <div style="margin-bottom: 28px; border-left: 6px solid #ea6666ff; padding-left: 16px;
                background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, transparent 100%);
                padding: 8px 0; border-radius: 0 8px 8px 0;">
      <h2 style="font-size: 32px; font-weight: 900; color: #ea6666ff; margin: 0; display: flex; gap: 12px;">
        <span>ğŸ“Š</span> ä»Šé€±ã®å‰²åˆ
      </h2>
    </div>

    <div style="background: linear-gradient(135deg,#ff7f7f,#ff4d4d);
                padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
      <canvas id="weeklyChart" height="260"></canvas>
      <ul id="activityCounts"></ul>
    </div>
  </div>

  <!-- ä»Šé€±ã®ã‚µãƒãƒªãƒ¼ -->
  <div class="summary-container bg-gradient-to-br from-gray-50 to-gray-100 p-8 rounded-2xl shadow-2xl">
    <div style="margin-bottom: 28px; border-left: 6px solid #667eea; padding-left: 16px;
                background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, transparent 100%);
                padding: 8px 0; border-radius: 0 8px 8px 0;">
      <h2 style="font-size: 32px; font-weight: 900; color: #667eea; margin: 0; display: flex; gap: 12px;">
        <span>ğŸ“Š</span> ä»Šé€±ã®ã‚µãƒãƒªãƒ¼
      </h2>
    </div>

    <div class="space-y-4">
      <!-- å‹‰å¼·å›æ•° -->
      <div style="background: linear-gradient(135deg,#667eea,#764ba2);
                  padding:20px;border-radius:16px;
                  display:flex;justify-content:space-between;align-items:center;
                  box-shadow:0 4px 12px rgba(102,126,234,0.3);">
        <div>
          <p style="font-size:13px;color:#e5e7eb;">ä»Šé€±ã€Œå‹‰å¼·ã™ã‚‹ã€å›æ•°</p>
          <p style="font-size:40px;font-weight:900;color:white;">
            <%= @week_study_count %><span style="font-size:20px;">å›</span>
          </p>
        </div>
        <span style="font-size:52px;">ğŸ“˜</span>
      </div>

      <!-- è¨˜éŒ²æ—¥æ•° -->
      <div style="background: linear-gradient(135deg,#f093fb,#f5576c);
                  padding:20px;border-radius:16px;
                  display:flex;justify-content:space-between;align-items:center;
                  box-shadow:0 4px 12px rgba(245,87,108,0.3);">
        <div>
          <p style="font-size:13px;color:#fde2e2;">ä»Šé€±ã®è¨˜éŒ²æ—¥æ•°</p>
          <p style="font-size:40px;font-weight:900;color:white;">
            <%= @week_recorded_days %><span style="font-size:20px;">æ—¥</span>
          </p>
        </div>
        <span style="font-size:52px;">ğŸ“…</span>
      </div>

      <!-- å‰²åˆ -->
      <div style="background: linear-gradient(135deg,#4facfe,#00f2fe);
                  padding:20px;border-radius:16px;
                  display:flex;justify-content:space-between;align-items:center;
                  box-shadow:0 4px 12px rgba(79,172,254,0.3);">
        <div>
          <p style="font-size:13px;color:#e0f2fe;">å‹‰å¼·ã‚’é¸ã‚“ã å‰²åˆ</p>
          <p style="font-size:40px;font-weight:900;color:white;">
            <%= @week_study_ratio %><span style="font-size:20px;">%</span>
          </p>
        </div>
        <span style="font-size:52px;">ğŸ“ˆ</span>
      </div>
    </div>
  </div>
</div>

<!-- ä»Šæ—¥ã®å±¥æ­´ -->
<div class="today-history-container bg-white p-4 rounded shadow-md">
  <h2 class="text-xl font-bold mb-3">ä»Šæ—¥ã®å±¥æ­´</h2>
  <ul style="list-style:none;padding:0;">
    <% @today_records.each do |record| %>
      <li style="display:flex;gap:12px;padding:12px;margin-bottom:8px;
                 border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.1);">
        <span style="font-size:20px;"><%= record.activity.icon %></span>
        <div>
          <span style="font-family:monospace;color:#6B7280;">
            <%= record.created_at.to_fs(:time) %>
          </span>
          <p style="font-weight:600;"><%= record.activity.name %></p>
          <% if record.memo.present? %>
            <p style="color:#4B5563;font-size:14px;"><%= record.memo %></p>
          <% end %>
        </div>
      </li>
    <% end %>
  </ul>
</div>

<!-- ä¸‹éƒ¨ãƒœã‚¿ãƒ³ -->
<div class="bottom-link-wrapper" style="text-align:center;margin:2rem auto;">
  <%= link_to "ğŸ“š è¡Œå‹•é¸æŠç”»é¢ã«è¡Œã", learning_path,
      style: "display:inline-block;padding:16px 32px;
              background:linear-gradient(135deg,#667eea,#764ba2);
              color:white;border-radius:12px;font-weight:700;
              text-decoration:none;" %>
</div>

<!-- Chart.js CDN (UMDç‰ˆ) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
  const initAnalytics = () => {
    const canvas = document.getElementById("weeklyChart");
    if (!canvas) return;

    // å‰å›ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
    if (window.weeklyChartInstance) window.weeklyChartInstance.destroy();

    fetch("<%= analytics_records_path(format: :json) %>")
      .then(res => res.json())
      .then(data => {
        const labels = data.chart.labels;
        const counts = data.chart.counts;

        if (counts.length === 0) {
          canvas.remove();
          document.getElementById("activityCounts").innerHTML =
            "<p>ä»Šé€±ã®è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>";
          return;
        }

        const ctx = canvas.getContext("2d");
        window.weeklyChartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [{
              data: counts,
              backgroundColor: ["#60a5fa","#34d399","#fbbf24","#f87171","#a78bfa"]
            }]
          },
          options: {
            plugins: {
              legend: { position: "top" },
              tooltip: {
                callbacks: {
                  label(context) {
                    const value = context.raw;
                    const total = context.dataset.data.reduce((a,b)=>a+b,0);
                    const percent = Math.round((value/total)*100);
                    return `${context.label}: ${value}å›ï¼ˆ${percent}%ï¼‰`;
                  }
                }
              }
            }
          }
        });

        // å·¦å´ãƒªã‚¹ãƒˆè¡¨ç¤º
        const colors = ["#60a5fa","#34d399","#fbbf24","#f87171","#a78bfa"];
        const list = document.getElementById("activityCounts");
        list.innerHTML = "";
        labels.forEach((label,i)=>{
          const li = document.createElement("li");
          li.className = "activity-count-item";
          li.innerHTML = `
            <div class="activity-left">
              <span class="activity-color" style="background-color:${colors[i % colors.length]}"></span>
              <span>${label}</span>
            </div>
            <span class="activity-count">${counts[i]}å›</span>
          `;
          list.appendChild(li);
        });
      })
      .catch(err => console.error("Chart fetch error:", err));
  };

  // DOM & Turbo ä¸¡æ–¹ã«å¯¾å¿œ
  document.addEventListener("DOMContentLoaded", initAnalytics);
  document.addEventListener("turbo:load", initAnalytics);
</script>

<style>
  /* ===== å…±é€š ===== */
  .analytics-wrapper {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    align-items: stretch;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .analytics-container,
  .summary-container {
    flex: 1 1 420px;
    max-width: 480px;
  }

  .today-history-container,
  .bottom-link-wrapper {
    max-width: 950px;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
  }
</style>